## 跨模态互学习增强字节码智能合约漏洞检测

### 摘要

>本文提出了一种新颖的跨模态相互学习框架，用于增强字节码上的智能合约漏洞检测。具体来说，我们参与两个网络，学生网络 S 作为主网络，教师网络 T 作为辅助网络。 T 采用两种模式，即**源代码及其相应的字节码作为输入**，而 S 仅输入**字节码**。通过向 T 学习，S 被训练来推断丢失的源代码嵌入，并结合这两种模式来实现精确的漏洞检测。为了进一步促进 S 和 T 之间的相互学习，我们提出了跨模态相互学习损失和两个转移损失。作为附带贡献，我们构建并发布了一个带标签的智能合约数据集，该数据集涉及四种类型的常见漏洞。实验结果表明，我们的方法明显超越了最先进的方法。
>
>

### 引言

> 在过去的十年里，区块链在实践和研究界都受到了相当多的关注 [28, 45]。区块链本质上是由全球记账节点（又称矿工）维护的分布式共享账本，遵循精心设计的共识协议，该协议规定了新区块的附加[39]。分布式存储在记账节点中的副本账本保证了交易的不可篡改，赋予了区块链防篡改和去中心化的特性。
>
>现代区块链，例如以太坊[43]，可以执行智能合约，这些合约是在区块链系统[39]之上运行的程序。开发人员能够在智能合约代码中实施任意规则来控制数字资产。一旦代码部署到区块链上，其定义的规则就会自动执行。由于区块链的不可篡改性，智能合约的执行严格遵守其预先定义的规则（即合约条款）且不可更改，对所有利益相关者都是公正的。
>
>到目前为止，以太坊的市值已超过 1780 亿美元[10]。随着它变得越来越普遍并具有更多价值，攻击者变得更有动力去挖掘和利用智能合约中的潜在问题。事实上，以太坊智能合约已经面临相当多的毁灭性漏洞攻击事件，并造成了巨大的经济损失[31]。例如，2017 年，由于 delegatecall 漏洞，价值超过 1.5 亿美元的以太币（即以太坊的加密货币）被冻结[36]。最近，攻击者利用 Cream.Finance 合约中的重入漏洞窃取了价值超过 1.3 亿美元的数字资产 [18]。与传统的程序在出现错误时可以更新不同，智能合约的错误是无法修补的，除非颠覆区块链（即控制整个区块链网络51%以上的算力[22]），而这几乎是不可能的。智能合约中的各种漏洞已成为严重的安全威胁。智能合约的有效漏洞检查器非常令人垂涎，最好是在部署到区块链之前。
>
>**存在方法和挑战**
>
>在仔细检查现有方法的已发布实现后，我们凭经验发现当前智能合约的错误检测方法可以大致分为两类。其中一项工作 [19, 40] 围绕传统的静态分析和模糊技术。他们利用固定模式来识别漏洞。然而，为复杂漏洞定义完美模式并非易事。另一项努力 [24, 52] 建立在深度学习在处理复杂数据方面的优越性之上，从而带来了令人印象深刻的性能提升。值得一提的是，当前的方法倾向于从合约源代码中检测漏洞，因为它包含完整的语义信息。不幸的是，绝大多数智能合约都不是开源的，只有字节码可以轻松访问[17]。虽然现有的工作[6]可以单独处理字节码，但由于难以从字节码恢复丰富的控制和数据流语义，因此无法获得高精度。
>
>尽管源代码和编译后的字节码之间存在显着差异，但它们的**密切联系是不可否认的**，如果没有另一种形式，一种形式可能显得不完整。在漏洞检测中，这两种模式可以相互补充，我们期望源代码提供全面的控制和数据流依赖性，而字节码提供简洁的指令信息。然而，在字节码智能合约漏洞检测中，面临的挑战是我们只有字节码可用，而源代码缺失。众所周知，将字节码恢复为源代码非常困难，尤其是对于智能合约而言[23]。我们非常想知道**是否有可能在源代码的帮助下改进字节码的智能合约漏洞检测**，即使在推理阶段源代码丢失的情况下也是如此。
>
>这促使我们提出以下三个关键设计。 (1) 使用收集的 40K 个既有源代码又有字节码的智能合约，我们训练一个教师网络 T，它吸收两种模式，即源代码和相应的字节码作为输入，并输出二进制标签，指示测试的函数是否具有特定的漏洞。从技术上讲，我们将源代码和字节码都转换为图结构，并使用图注意力网络来处理它们。 (2) 然后我们训练一个学生网络 S，即主网络，它从教师网络 T（即辅助网络）中**提取知识。具体来说，通过向 T 学习，S 能够从字节码嵌入预测源代码嵌入**。在推理阶段，S 可以从字节码中推断出丢失的源代码嵌入，并结合这两种模式来实现准确的检测。 (3)为了进一步实现S和T之间的相互学习，我们提出了一种以理论驱动损失为框架的跨模态相互学习策略。我们想强调的是，我们不会尝试重建整个源代码，而是推断有利于提高字节码漏洞检测准确性的源代码嵌入。
>
>**贡献点**
>
>- 我们研究了相互学习策略是否可以在智能合约源代码丢失的挑战性场景中提供帮助。据我们所知，我们是第一个研究利用相互学习来增强智能合约漏洞检测的想法的人。
>- 我们提出了一种新颖的师生框架，用于字节码上的智能合约漏洞检测，实现从双模态教师网络到单模态学生网络的有效知识转移。
>- 我们的方法设定了新的最先进的性能，并总体上提供了有趣的见解。本着开放科学的精神，我们发布了我们的实现和数据集1，希望能够促进未来的研究。

### 研究问题

>提出了字节码中的智能合约函数 F，我们的目标是学习一个学生网络 S，它仅将字节码作为输入，并且能够预测其标签 Y ∈ {0, 1}。 Y = 1 表示 A 具有某种类型的漏洞，Y = 0 表示 f 是安全的。我们有兴趣知道 S 在与由源代码和字节码提供的教师网络 T 进行协作训练后是否可以实现更精确的预测。在这项工作中，我们重点关注以下四类常见漏洞。
>
>**重入漏洞**
>
>**时间戳依赖**
>
>当函数使用区块时间戳作为执行关键操作的条件时，例如使用未来区块的 block.timestamp 来确定赌博游戏的获胜者，就存在漏洞。开采区块的矿工有能力在很短的时间间隔（大约 900 秒）内改变区块的时间戳 [50]。因此，恶意矿工可能会操纵区块时间戳来获取非法收益
>
>**整数上下溢出**
>
>当算术运算尝试生成超出整数类型范围的数值时，就会发生这种情况。例如，如果数字 A 的类型为 uint8，则其值存储为范围从 0 到 28 -1 的 8 位无符号数。当我们尝试给A分配一个超出这个范围的值时，即大于255或小于0时，就会出现整数溢出/欠流漏洞。
>
>**Delegatecall**

### 方法概要

>我们提出的框架的整体流程由三个关键组件组成：1）代码语义建模模块，2）师生框架，3）跨模态相互学习策略。具体来说，在训练阶段，我们会得到一组带标签的智能合约函数，其中包含可用的字节码和源代码。我们首先开发自动化工具，将智能合约的源代码和字节码分别转换为代码语义图和控制流图。它们的图特征是通过使用图注意网络来提取的。此后，我们构建了一个师生框架，其中包含双模态教师网络 T 和单模态学生网络 S。最后，我们利用**相互学习损失和两个转移损失来协作训练两个网络**。在推理阶段，当仅呈现字节码时，S 能够预测丢失的源代码嵌入，并结合两种模式来实现更准确的检测。我们要强调的是，学生网络 S 是主网络，教师网络 T 仅在训练阶段使用。

### 代码语义建模模块

>图处理。对于源代码，我们设计了代码语义图（CSG）来框定合约代码中的控制和数据依赖关系。按照[24]，我们提取两种图节点和三种类型的边。 CSG 中的节点象征不同的程序元素，例如关键函数调用和变量，而边捕获节点之间的控制和数据流连接。特别地，每个边都有一个时间顺序，这与其在代码中的顺序一致。
>
>对于字节码，我们提取控制流图（CFG），其中包括字节码块（即节点）和控制流边。字节码块包含一组指令。之前的工作 [47] 已经揭示了 BERT 模型在处理程序指令方面的成功。启发式地，我们求助于 BERT 网络来编码字节码块。 (1)我们通过指令级任务和块级任务预训练BERT模型。 (i)对于块内的指令，使用掩码语言任务（MLM）来获取指令级信息。 （ii）对于连接到邻居的块，我们采用邻接块预测任务（ABP）来捕获控制流信息和相邻块之间的关系。 (2)考虑到不同漏洞之间的差异，我们对每种类型的漏洞执行预训练的 BERT 的专门微调任务。 (3) 最后，通过微调后的 BERT 提取字节码块的特征。值得注意的是，我们将 BERT 的训练细节放在附录 C 中。
>
>**代码语义图构建CSG**
>
>![image-20231011203244736](https://raw.githubusercontent.com/m1crofan/image/main/image-20231011203244736.png)
>
>为了清楚地说明如何将智能合约函数的源代码表征为代码语义图，我们在图中提供了一个简化示例。以合约 Victim 为例，假设我们要评估其 withdraw 函数是否存在重入漏洞。如图 2 中间所示，函数 withdraw 首先被建模为核心节点 C1，因为其内部代码包含 call.value 调用（表示为关键调用）。然后，按照代码的时间顺序，我们将临界状态变量 Balance[msg.sender]作为核心节点C2，而局部变量sum则作为普通节点N1。
>
>对 call.value 的调用也被提取为核心节点C3，而虚拟攻击合约的回退功能则由正常节点Nf表征。为了捕捉这些节点之间丰富的语义依赖关系，我们构建了三类边，即控制流边、数据流边和回退边 [25]。每条边都描述了被测函数可能经过的路径，而边的时序数则代表其在函数中的顺序。
>
>考虑到不同的函数会产生具有不同结构的图，我们受到[52]的启发，并通过删除所有正常节点并将其特征合并到最近的核心节点来标准化代码语义图。例如，图2第二图中的普通节点N1被移除，其特征聚合到最近的核心节点C2和C3。对于具有多个最近的核心节点的普通节点，其特征被传递给所有这些节点。连接到删除的普通节点的**边将被保留**，但其起始或结束节点移动到**相应的核心节点**。图 2 的第三张图展示了图 2 的第二张图的归一化图。由于图神经网络通常在传播信息方面很丰富，因此归一化过程也有助于突出核心节点。
>
>**控制流图CFG**
>
>![image-20231011204015551](https://raw.githubusercontent.com/m1crofan/image/main/image-20231011204015551.png)
>
>为了清楚地描述字节码控制流图的构建过程，我们在图3中给出了一个具体的示例。给定智能合约源代码，我们使用公共编译器将其翻译为字节码，并开发自动化工具BinaryCFGExtractor2来提取控制已编译字节码的流图。字节码控制流图（CFG）由字节码基本块（即节点）和控制流边组成。 (1) 我们的第一个认识是基本块包含 EVM 指令序列。一个基本块通过CFG中的分支指令连接到后续基本块[34]。在我们的分析中，我们将分支指令（例如JUMP、JUMPI、RETURN）视为基本块结束的标志，这意味着分支指令被视为对基本块进行分段的标志。为了进一步展示字节码指令，我们在附录A中列出了独特的字节码值及其相应的定义和指令。 (2)我们的第二个见解是**基本块通过控制流边缘彼此紧密相关而不是孤立的**。控制流边缘捕获条件语句或调用语句的控制流依赖性。 (3) CFG中的控制流边主要分为三类，在图3右侧用不同的颜色表示。无条件跳转指令（即JUMP）用蓝色箭头突出显示。真或假条件跳转指令（即 JUMPI）分别用绿色和红色箭头表示。
>
>图嵌入蒸馏。获得这两种图后，我们基于图注意网络（GAT）[41]的架构来学习源代码和字节码的高级图语义嵌入，即 GA 和 GA ∈ RA ，分别。图嵌入提取由两个阶段组成，即消息传播阶段和聚合阶段。在消息传播阶段，网络按照代码中的顺序沿边缘传递信息。例如，在时间步 A，消息流过第 A 个时间边 AA 并更新 AA 的末端节点的隐藏状态。此后，GAT 通过关注其邻居来计算每个节点的隐藏状态：