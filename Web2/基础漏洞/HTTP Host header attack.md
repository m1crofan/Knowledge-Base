错误配置和有缺陷的业务逻辑漏洞如何通过HTTP Host 头使网站遭受各种攻击。

Host头是从HTTP/1.1强制的请求头。它指定客户端要访问的域名。例如，当用户访问`https://portswigger.net/web-security`时，会生成如下HTTP请求

```http
GET /web-security HTTP/1.1
Host: portswigger.net
```

在某些情况下，例如，当请求已由中间系统转发时，Host值可能会到达预期的后端组件之前发生更改。

HTTP Host头的用途是帮助确定客户端要与之通信的后端组件。如果请求不包含Host头，或者Host头格式不正确，则在将传入请求路由到预期应用程序时可能会导致错误。

如今，很大程度上由于基于云的解决方案和外包大部分相关架构不断增长的趋势，使用同一IP地址访问多个网站的应用程序是很常见的。

当通过同一IP地址访问多个应用程序时，这通常是以下情况之一

- **虚拟主机**：尽管不同的网站中每一个都有不同的域名，但它们都与服务器共享一个公共IP。
- **中介路由**：客户端和服务器之间的所有流量都通过中间路由可能是一个简单的负载均衡、反向代理、CDN。在这种情况下，即使网站托管在单独的后端服务器上，它们的所有域名也会解析为中间组件的单个IP地址。

HTTP头攻击利用以不安全方式处理主机头的易受攻击的网站。如果服务器隐式信任HOST头，并且未能正确验证或转义它，则攻击者可能能够使用此输入注入操作服务器端行为的有害payload。

现成的 Web 应用程序通常不知道它们部署在哪个域上，除非在安装过程中在配置文件中手动指定。当他们需要知道当前域时，例如，要生成电子邮件中包含的绝对 URL，他们可能会求助于 Host 标头中检索域：

```html
<a href="https://_SERVER['HOST']/support">Contact support</a>
```

由于 Host 标头实际上是用户可控的，因此这种做法可能会导致许多问题。如果输入未正确转义或验证，则 Host 标头是利用一系列其他漏洞的组合拳。

### 密码重置投毒

密码重置投毒是一种技术，攻击者通过该技术操纵易受攻击的网站生成指向其控制下的域密码重置链接。可以利用此行为来窃取重置任意用户密码所需的token。

几乎所有需要登录的网站还实现了允许用户在忘记密码时重置密码的功能。有几种方法可以做到这一点，具有不同程度的安全性和实用性。最常见的方法之一是这样的：

- 用户输入其用户名或电子邮箱并提交密码重置请求。
- 该网站会检查此用户是否存在，然后生成一个临时、唯一、高熵的token，该token与后端用户账户相关联。
- 该网站会向用户发送一封电子邮件，其中包含用于重置其密码的链接，用户的唯一重置token作为查询参数包含在相应的URL中：

```url
https://normal-website.com/reset?token=0a1b2c3d4e5f6g7h8i9j
```

- 当用户访问此URL时，网站会检查提供的token是否有效，并使用它来确定要重置的账户。如果一切正常，用户可以选择输入新密码。最后，token被销毁。

与其他一些方法相比，此过程足够简单且相对安全。但是，它的安全性依赖于以下原则：**只有目标用户才能访问其电子邮件收件箱，因此才能访问其唯一令牌**。密码重置中毒是一种窃取此令牌以更改其他用户密码的方法。

如果发送给用户的URL是**基于可控输入动态生成的**，则可能会构建密码重置中毒攻击，如下所示：

- 攻击者根据需要获取受害者的电子邮箱地址或用户名，并代表他们提交密码重置请求。提交表单时，他们会截获生成的HTTP请求并修改HOST头。使其指向他们控制的域。
- 受害者直接从网站上收到真正的密码重置邮件。这似乎包含一个用于重置其密码的普通链接，并且至关重要的是，其中包含与其账户关联的有效密码重置token。但是，URL中的域名指向攻击者的服务器

```url
https://evil-user.net/reset?token=0a1b2c3d4e5f6g7h8i9j
```

- 如果受害者点击此链接，则密码重置令牌将传递给攻击者。

[Lab: Basic password reset poisoning](https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning/lab-host-header-basic-password-reset-poisoning)

>该实验的思路就是，后端发送给用户邮件的方式是通过拼接HTTP请求的HOST头。

[Lab: Password reset poisoning via middleware](https://portswigger.net/web-security/authentication/other-mechanisms/lab-password-reset-poisoning-via-middleware)

>该实验的思路是，后端发送给用户邮件的方式是通过拼接HTTP请求的`X-Forwarded-Host`。
>
>chat
>
>在一台服务器上托管多个域名的情况下，可以帮助后端服务器识别请求的实际是哪个域名。